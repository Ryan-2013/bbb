<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ›¸ç±é€£çºŒæ‹ç…§å‘½åå·¥å…·</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 20px; }
    video, canvas { max-width: 90%; margin-top: 10px; }
    input, button { margin: 10px; font-size: 16px; padding: 6px; }
  </style>
</head>
<body>
  <h2>ğŸ“š æ›¸ç±é€£çºŒæ‹ç…§å‘½åå·¥å…·</h2>

  <label>æ›¸åï¼š<input type="text" id="bookName" placeholder="ä¾‹å¦‚ï¼šCèªè¨€å…¥é–€"></label><br>
  <label>ç•¶å‰é æ•¸ï¼š<input type="number" id="pageNumber" value="1"></label><br>

  <video id="video" autoplay playsinline width="480" height="360"></video><br>

  <button onclick="capture()">ğŸ“¸ æ‹ç…§</button>
  <button onclick="downloadZip()">â¬‡ï¸ ä¸‹è¼‰å…¨éƒ¨ ZIP</button><br>

  <p id="status">å°šæœªæ‹æ”</p>

  <canvas id="canvas" width="480" height="360" style="display:none;"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const pageInput = document.getElementById('pageNumber');
    const bookInput = document.getElementById('bookName');
    const status = document.getElementById('status');

    const zip = new JSZip();
    const imagesFolder = zip.folder("images");

    let captureCount = 0;

    // å•Ÿç”¨æ”å½±æ©Ÿ
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(err => alert("ç„¡æ³•å•Ÿç”¨æ”å½±æ©Ÿï¼š" + err));

    function sanitize(str) {
      return str.trim().replace(/[^a-zA-Z0-9ä¸€-é¾¥_\-]/g, "_");
    }

    async function capture() {
      const book = sanitize(bookInput.value);
      if (!book) {
        alert("è«‹å…ˆè¼¸å…¥æ›¸å");
        return;
      }

      const page = parseInt(pageInput.value, 10);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));

      const filename = `${book}_${page}.png`;
      imagesFolder.file(filename, blob);
      captureCount++;

      status.textContent = `âœ… å·²æ‹æ” ${captureCount} å¼µï¼ˆæœ€æ–°ç‚º ${filename}ï¼‰`;

      pageInput.value = page + 1;
    }

    async function downloadZip() {
      if (captureCount === 0) {
        alert("å°šæœªæ‹ç…§ï¼Œç„¡æª”æ¡ˆå¯ä¸‹è¼‰ï¼");
        return;
      }
      status.textContent = "ğŸ“¦ æ­£åœ¨æ‰“åŒ… ZIPï¼Œè«‹ç¨å€™...";
      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, `${sanitize(bookInput.value)}_pages.zip`);
      status.textContent = "âœ… ä¸‹è¼‰å®Œæˆï¼ä½ å¯ä»¥æ¸…é™¤é‡æ‹æˆ–é—œæ‰ç¶²é ã€‚";
    }
  </script>
</body>
</html>
